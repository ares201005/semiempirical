import numpy as np
from math  import cos, sin, acos, atan
def rotation_matrix_auto(xij):
    sij = xij / np.linalg.norm(xij)
    theta = acos(sij[2])
    if abs(sij[0]) + abs(sij[1]) < 1e-8:
        phi = 0.0
    elif abs(sij[0]) < 1e-8:
        if sij[1] > 0:
            phi = np.pi / 2.0
        else:
            phi = -np.pi / 2.0
    else:
        phi = atan(sij[1]/sij[0])
    if abs(phi) < 1e-8 and sij[0] < -1.0e-8:
        phi = np.pi

    T = np.array([[1.0, 0.0, 0.0, 0.0], [0.0, cos(theta)*cos(phi), cos(theta)*sin(phi), -sin(theta)],
                     [0.0, -sin(phi), cos(phi), 0.0], [0.0, sin(theta)*cos(phi), sin(theta)*sin(phi), cos(theta)]])
    T2 = np.zeros((10,10))

    T2[0][0] =     T[0,0]*T[0,0]
    T2[1][1] =     T[0,0]*T[1,1]
    T2[3][1] =     T[0,0]*T[2,1]
    T2[6][1] =     T[0,0]*T[3,1]
    T2[2][2] =     T[1,1]*T[1,1]
    T2[4][2] = 2.0*T[1,1]*T[2,1]
    T2[5][2] =     T[2,1]*T[2,1]
    T2[7][2] = 2.0*T[1,1]*T[3,1]
    T2[8][2] = 2.0*T[2,1]*T[3,1]
    T2[9][2] =     T[3,1]*T[3,1]
    T2[1][3] =     T[0,0]*T[1,2]
    T2[3][3] =     T[0,0]*T[2,2]
    T2[6][3] =     T[0,0]*T[3,2]
    T2[2][4] =     T[1,1]*T[1,2]
    T2[4][4] =     T[1,1]*T[2,2]+T[2,1]*T[1,2]
    T2[5][4] =     T[2,1]*T[2,2]
    T2[7][4] =     T[1,1]*T[3,2]+T[3,1]*T[1,2]
    T2[8][4] =     T[2,1]*T[3,2]+T[3,1]*T[2,2]
    T2[9][4] =     T[3,1]*T[3,2]
    T2[2][5] =     T[1,2]*T[1,2]
    T2[4][5] = 2.0*T[1,2]*T[2,2]
    T2[5][5] =     T[2,2]*T[2,2]
    T2[7][5] = 2.0*T[1,2]*T[3,2]
    T2[8][5] = 2.0*T[2,2]*T[3,2]
    T2[9][5] =     T[3,2]*T[3,2]
    T2[1][6] =     T[0,0]*T[1,3]
    T2[6][6] =     T[0,0]*T[3,3]
    T2[2][7] =     T[1,1]*T[1,3]
    T2[4][7] =     T[2,1]*T[1,3]
    T2[7][7] =     T[1,1]*T[3,3]+T[3,1]*T[1,3]
    T2[8][7] =     T[2,1]*T[3,3]
    T2[9][7] =     T[3,1]*T[3,3]
    T2[2][8] =     T[1,2]*T[1,3]
    T2[4][8] =     T[2,2]*T[1,3]
    T2[7][8] =     T[1,2]*T[3,3]+T[3,2]*T[1,3]
    T2[8][8] =     T[2,2]*T[3,3]
    T2[9][8] =     T[3,2]*T[3,3]
    T2[2][9] =     T[1,3]*T[1,3]
    T2[7][9] = 2.0*T[1,3]*T[3,3]
    T2[9][9] =     T[3,3]*T[3,3]

    return T2